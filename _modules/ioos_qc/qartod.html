
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>ioos_qc.qartod &#8212; ioos_qc 0.2.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ioos_qc.qartod</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># coding=utf-8</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="k">import</span> <span class="n">Real</span> <span class="k">as</span> <span class="n">N</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pygc</span> <span class="k">import</span> <span class="n">great_distance</span>

<span class="kn">from</span> <span class="nn">ioos_qc.utils</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">isnan</span><span class="p">,</span>
    <span class="n">isfixedlength</span>
<span class="p">)</span>

<span class="n">L</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># noqa</span>


<div class="viewcode-block" id="QartodFlags"><a class="viewcode-back" href="../../api/ioos_qc.html#ioos_qc.qartod.QartodFlags">[docs]</a><span class="k">class</span> <span class="nc">QartodFlags</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Primary flags for QARTOD.&quot;&quot;&quot;</span>

    <span class="n">GOOD</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">UNKNOWN</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">SUSPECT</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">FAIL</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">MISSING</span> <span class="o">=</span> <span class="mi">9</span></div>


<span class="n">FLAGS</span> <span class="o">=</span> <span class="n">QartodFlags</span>  <span class="c1"># Default name for all check modules</span>

<span class="n">span</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Span&#39;</span><span class="p">,</span> <span class="s1">&#39;minv maxv&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="mapdates"><a class="viewcode-back" href="../../api/ioos_qc.html#ioos_qc.qartod.mapdates">[docs]</a><span class="k">def</span> <span class="nf">mapdates</span><span class="p">(</span><span class="n">dates</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dates</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">):</span>
        <span class="c1"># numpy datetime objects</span>
        <span class="k">return</span> <span class="n">dates</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Finally try unix epoch seconds</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># strings work here but we don&#39;t advertise that</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span></div>
            

<div class="viewcode-block" id="qartod_compare"><a class="viewcode-back" href="../../api/ioos_qc.html#ioos_qc.qartod.qartod_compare">[docs]</a><span class="k">def</span> <span class="nf">qartod_compare</span><span class="p">(</span><span class="n">vectors</span> <span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">N</span><span class="p">]]</span>
                   <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Aggregates an array of flags by precedence into a single array.</span>

<span class="sd">    Args:</span>
<span class="sd">        vectors: An array of uniform length arrays representing individual flags</span>

<span class="sd">    Returns:</span>
<span class="sd">        A masked array of aggregated flag data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vectors</span><span class="p">]</span>
    <span class="c1"># Assert that all of the vectors are the same size.</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">s</span> <span class="o">==</span> <span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">])</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vectors</span><span class="p">])</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">result</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">QartodFlags</span><span class="o">.</span><span class="n">MISSING</span><span class="p">)</span>

    <span class="n">priorities</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">QartodFlags</span><span class="o">.</span><span class="n">MISSING</span><span class="p">,</span>
        <span class="n">QartodFlags</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">,</span>
        <span class="n">QartodFlags</span><span class="o">.</span><span class="n">GOOD</span><span class="p">,</span>
        <span class="n">QartodFlags</span><span class="o">.</span><span class="n">SUSPECT</span><span class="p">,</span>
        <span class="n">QartodFlags</span><span class="o">.</span><span class="n">FAIL</span>
    <span class="p">]</span>
    <span class="c1"># For each of the priorities in order, set the resultant array to the the</span>
    <span class="c1"># flag where that flag exists in each of the vectors.</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">priorities</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vectors</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="location_test"><a class="viewcode-back" href="../../api/ioos_qc.html#ioos_qc.qartod.location_test">[docs]</a><span class="k">def</span> <span class="nf">location_test</span><span class="p">(</span><span class="n">lon</span> <span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">N</span><span class="p">],</span>
                  <span class="n">lat</span> <span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">N</span><span class="p">],</span>
                  <span class="n">bbox</span> <span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>
                  <span class="n">range_max</span> <span class="p">:</span> <span class="n">N</span> <span class="o">=</span> <span class="kc">None</span>
                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Checks that a location is within reasonable bounds.</span>

<span class="sd">    Checks that longitude and latitude are within reasonable bounds defaulting</span>
<span class="sd">    to lon = [-180, 180] and lat = [-90, 90].  Optionally, check for a maximum</span>
<span class="sd">    range parameter in great circle distance defaulting to meters which can</span>
<span class="sd">    also use a unit from the quantities library. Missing and masked data is</span>
<span class="sd">    flagged as UNKNOWN.</span>

<span class="sd">    Args:</span>
<span class="sd">        lon: Longitudes as a numeric numpy array or a list of numbers.</span>
<span class="sd">        lat: Latitudes as a numeric numpy array or a list of numbers.</span>
<span class="sd">        bbox: A length 4 tuple expressed in (minx, miny, maxx, maxy) [optional].</span>
<span class="sd">        range_max: Maximum allowed range expressed in geodesic curve distance (meters).</span>

<span class="sd">    Returns:</span>
<span class="sd">        A masked array of flag values equal in size to that of the input.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bboxnt</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;BBOX&#39;</span><span class="p">,</span> <span class="s1">&#39;minx miny maxx maxy&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">isfixedlength</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">bboxnt</span><span class="p">(</span><span class="o">*</span><span class="n">bbox</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">))</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">lon</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">lat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Lon (</span><span class="si">{0.shape}</span><span class="s1">) and lat (</span><span class="si">{1.shape}</span><span class="s1">) are different shapes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Save original shape</span>
    <span class="n">original_shape</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># Start with everything as passing (1)</span>
    <span class="n">flag_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>

    <span class="c1"># If either lon or lat are masked we just set the flag to MISSING</span>
    <span class="n">mloc</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">lat</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">flag_arr</span><span class="p">[</span><span class="n">mloc</span><span class="p">]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">MISSING</span>

    <span class="c1"># If there is only one masked value fail the location test</span>
    <span class="n">mismatch</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">mask</span> <span class="o">!=</span> <span class="n">lat</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">flag_arr</span><span class="p">[</span><span class="n">mismatch</span><span class="p">]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">FAIL</span>

    <span class="k">if</span> <span class="n">range_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lon</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Calculating the great_distance between each point</span>
        <span class="c1"># Flag suspect any distance over range_max</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">great_distance</span><span class="p">(</span>
            <span class="n">start_latitude</span><span class="o">=</span><span class="n">lat</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">end_latitude</span><span class="o">=</span><span class="n">lat</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
            <span class="n">start_longitude</span><span class="o">=</span><span class="n">lon</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">end_longitude</span><span class="o">=</span><span class="n">lon</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="p">)[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span>
        <span class="n">flag_arr</span><span class="p">[</span><span class="n">d</span> <span class="o">&gt;</span> <span class="n">range_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">SUSPECT</span>

    <span class="c1"># Ignore warnings when comparing NaN values even though they are masked</span>
    <span class="c1"># https://github.com/numpy/numpy/blob/master/doc/release/1.8.0-notes.rst#runtime-warnings-when-comparing-nan-numbers</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">flag_arr</span><span class="p">[(</span><span class="n">lon</span> <span class="o">&lt;</span> <span class="n">bbox</span><span class="o">.</span><span class="n">minx</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lat</span> <span class="o">&lt;</span> <span class="n">bbox</span><span class="o">.</span><span class="n">miny</span><span class="p">)</span> <span class="o">|</span>
                 <span class="p">(</span><span class="n">lon</span> <span class="o">&gt;</span> <span class="n">bbox</span><span class="o">.</span><span class="n">maxx</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lat</span> <span class="o">&gt;</span> <span class="n">bbox</span><span class="o">.</span><span class="n">maxy</span><span class="p">)]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">FAIL</span>

    <span class="k">return</span> <span class="n">flag_arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span></div>


<div class="viewcode-block" id="gross_range_test"><a class="viewcode-back" href="../../api/ioos_qc.html#ioos_qc.qartod.gross_range_test">[docs]</a><span class="k">def</span> <span class="nf">gross_range_test</span><span class="p">(</span><span class="n">inp</span> <span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">N</span><span class="p">],</span>
                     <span class="n">fail_span</span> <span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">],</span>
                     <span class="n">suspect_span</span> <span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Checks that values are within reasonable range bounds.</span>

<span class="sd">    Given a 2-tuple of minimum/maximum values, flag data outside of the given</span>
<span class="sd">    range as FAIL data.  Optionally also flag data which falls outside of a user</span>
<span class="sd">    defined range as SUSPECT. Missing and masked data is flagged as UNKNOWN.</span>

<span class="sd">    Args:</span>
<span class="sd">        inp: Input data as a numeric numpy array or a list of numbers.</span>
<span class="sd">        fail_span: 2-tuple range which to flag outside data as FAIL.</span>
<span class="sd">        suspect_span: 2-tuple range which to flag outside data as SUSPECT. [optional]</span>

<span class="sd">    Returns:</span>
<span class="sd">        A masked array of flag values equal in size to that of the input.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">isfixedlength</span><span class="p">(</span><span class="n">fail_span</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">sspan</span> <span class="o">=</span> <span class="n">span</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="n">fail_span</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">))</span>

    <span class="c1"># Save original shape</span>
    <span class="n">original_shape</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="c1"># Start with everything as passing (1)</span>
    <span class="n">flag_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>

    <span class="c1"># If the value is masked set the flag to MISSING</span>
    <span class="n">flag_arr</span><span class="p">[</span><span class="n">inp</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">MISSING</span>

    <span class="k">if</span> <span class="n">suspect_span</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">isfixedlength</span><span class="p">(</span><span class="n">suspect_span</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">uspan</span> <span class="o">=</span> <span class="n">span</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="n">suspect_span</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">uspan</span><span class="o">.</span><span class="n">minv</span> <span class="o">&lt;</span> <span class="n">sspan</span><span class="o">.</span><span class="n">minv</span> <span class="ow">or</span> <span class="n">uspan</span><span class="o">.</span><span class="n">maxv</span> <span class="o">&gt;</span> <span class="n">sspan</span><span class="o">.</span><span class="n">maxv</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;User span range may not exceed sensor span&#39;</span><span class="p">)</span>
        <span class="c1"># Flag suspect outside of user span</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">flag_arr</span><span class="p">[(</span><span class="n">inp</span> <span class="o">&lt;</span> <span class="n">uspan</span><span class="o">.</span><span class="n">minv</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">inp</span> <span class="o">&gt;</span> <span class="n">uspan</span><span class="o">.</span><span class="n">maxv</span><span class="p">)]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">SUSPECT</span>

    <span class="c1"># Flag suspect outside of sensor span</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">flag_arr</span><span class="p">[(</span><span class="n">inp</span> <span class="o">&lt;</span> <span class="n">sspan</span><span class="o">.</span><span class="n">minv</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">inp</span> <span class="o">&gt;</span> <span class="n">sspan</span><span class="o">.</span><span class="n">maxv</span><span class="p">)]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">FAIL</span>

    <span class="k">return</span> <span class="n">flag_arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span></div>


<div class="viewcode-block" id="ClimatologyConfig"><a class="viewcode-back" href="../../api/ioos_qc.html#ioos_qc.qartod.ClimatologyConfig">[docs]</a><span class="k">class</span> <span class="nc">ClimatologyConfig</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        tspan: 2-tuple range.</span>
<span class="sd">                If period is defined, then this is a numeric range.</span>
<span class="sd">                If period is not defined, then its a date range.</span>
<span class="sd">        vspan: 2-tuple range of valid values. This is passed in as the suspect_span to the gross_range test.</span>
<span class="sd">        zspan: (optional) Vertical (depth) range, in meters positive down</span>
<span class="sd">        period: (optional) The unit the tspan argument is in. Defaults to datetime object</span>
<span class="sd">                but can also be any attribute supported by a pandas Timestamp object.</span>
<span class="sd">                See: https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Timestamp.html                    </span>
<span class="sd">                    * year</span>
<span class="sd">                    * week / weekofyear</span>
<span class="sd">                    * dayofyear</span>
<span class="sd">                    * dayofweek</span>
<span class="sd">                    * quarter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mem</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;window&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;tspan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;vspan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;zspan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;period&#39;</span>
    <span class="p">])</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">members</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">members</span> <span class="o">=</span> <span class="n">members</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_members</span> <span class="o">=</span> <span class="n">members</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">members</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_members</span>

<div class="viewcode-block" id="ClimatologyConfig.values"><a class="viewcode-back" href="../../api/ioos_qc.html#ioos_qc.qartod.ClimatologyConfig.values">[docs]</a>    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tind</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="n">zind</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            tind: Value to test for inclusion between time bounds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">span</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_members</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># If a period is defined, extract the attribute from the</span>
                <span class="c1"># pd.Timestamp object before comparison. The min and max</span>
                <span class="c1"># values are in this period unit already.</span>
                <span class="n">tind_copy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tind</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">period</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If a period isn&#39;t defined, make a new Timestamp object</span>
                <span class="c1"># to align with the above name &#39;tind_copy&#39;</span>
                <span class="n">tind_copy</span> <span class="o">=</span> <span class="n">tind</span>

            <span class="c1"># If we are between times</span>
            <span class="k">if</span> <span class="n">tind_copy</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">tspan</span><span class="o">.</span><span class="n">minv</span> <span class="ow">and</span> <span class="n">tind_copy</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">tspan</span><span class="o">.</span><span class="n">maxv</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">isnan</span><span class="p">(</span><span class="n">zind</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isnan</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">zspan</span><span class="p">):</span>
                    <span class="c1"># If we are between depths</span>
                    <span class="k">if</span> <span class="n">zind</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">zspan</span><span class="o">.</span><span class="n">minv</span> <span class="ow">and</span> <span class="n">zind</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">zspan</span><span class="o">.</span><span class="n">maxv</span><span class="p">:</span>
                        <span class="n">span</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">vspan</span>
                <span class="k">elif</span> <span class="n">isnan</span><span class="p">(</span><span class="n">zind</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isnan</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">zspan</span><span class="p">):</span>
                    <span class="n">span</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">vspan</span>
        <span class="k">return</span> <span class="n">span</span></div>

<div class="viewcode-block" id="ClimatologyConfig.add"><a class="viewcode-back" href="../../api/ioos_qc.html#ioos_qc.qartod.ClimatologyConfig.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">tspan</span> <span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">],</span>
            <span class="n">vspan</span> <span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">],</span>
            <span class="n">zspan</span> <span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">period</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">assert</span> <span class="n">isfixedlength</span><span class="p">(</span><span class="n">tspan</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># If period is defined, tspan is a numeric</span>
        <span class="c1"># if it isn&#39;t defined, its a parsable date</span>
        <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tspan</span> <span class="o">=</span> <span class="n">span</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="n">tspan</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tspan</span> <span class="o">=</span> <span class="n">span</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">([</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">tspan</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">tspan</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">]))</span>

        <span class="k">assert</span> <span class="n">isfixedlength</span><span class="p">(</span><span class="n">vspan</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">vspan</span> <span class="o">=</span> <span class="n">span</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="n">vspan</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">zspan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">isfixedlength</span><span class="p">(</span><span class="n">zspan</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">zspan</span> <span class="o">=</span> <span class="n">span</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="n">zspan</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Test to make sure this is callable on a Timestamp</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">period</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The period &quot;</span><span class="si">{period}</span><span class="s1">&quot; is not recognized&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_members</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">(</span>
                <span class="n">tspan</span><span class="p">,</span>
                <span class="n">vspan</span><span class="p">,</span>
                <span class="n">zspan</span><span class="p">,</span>
                <span class="n">period</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ClimatologyConfig.check"><a class="viewcode-back" href="../../api/ioos_qc.html#ioos_qc.qartod.ClimatologyConfig.check">[docs]</a>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tinp</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">zinp</span><span class="p">):</span>

        <span class="c1"># Start with everything as UNKNOWN (1)</span>
        <span class="n">flag_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="n">flag_arr</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">QartodFlags</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">)</span>

        <span class="c1"># If the value is masked set the flag to MISSING</span>
        <span class="n">flag_arr</span><span class="p">[</span><span class="n">inp</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">MISSING</span>

        <span class="c1"># Iterate over each member and apply its spans on the input data.</span>
        <span class="c1"># Member spans are applied in order and any data points that fall into</span>
        <span class="c1"># more than one member are flagged by each one.</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_members</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># If a period is defined, extract the attribute from the</span>
                <span class="c1"># pd.DatetimeIndex object before comparison. The min and max</span>
                <span class="c1"># values are in this period unit already.</span>
                <span class="n">tinp_copy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tinp</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If a period isn&#39;t defined, make a new Timestamp object</span>
                <span class="c1"># to align with the above name &#39;tinp_copy&#39;</span>
                <span class="n">tinp_copy</span> <span class="o">=</span> <span class="n">tinp</span>

            <span class="c1"># If a zspan is defined but we don&#39;t have z input (zinp), skip this member</span>
            <span class="c1"># Note: `zinp.any()` can return `np.ma.masked` so we also check using isnan</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isnan</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">zspan</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">zinp</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">isnan</span><span class="p">(</span><span class="n">zinp</span><span class="o">.</span><span class="n">any</span><span class="p">())):</span>
                <span class="k">continue</span>

            <span class="c1"># Indexes that align with the T</span>
            <span class="n">t_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">tinp_copy</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">tspan</span><span class="o">.</span><span class="n">minv</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tinp_copy</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">tspan</span><span class="o">.</span><span class="n">maxv</span><span class="p">)</span>

            <span class="c1"># Indexes that align with the Z</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isnan</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">zspan</span><span class="p">):</span>
                <span class="c1"># Only test non-masked values between the min and max</span>
                <span class="n">z_idx</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">zinp</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">zinp</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">zspan</span><span class="o">.</span><span class="n">minv</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">zinp</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">zspan</span><span class="o">.</span><span class="n">maxv</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Only test the values with masked Z, ie values with no Z</span>
                <span class="n">z_idx</span> <span class="o">=</span> <span class="n">zinp</span><span class="o">.</span><span class="n">mask</span>
                
            <span class="c1"># Combine the T and Z indexes</span>
            <span class="n">values_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_idx</span> <span class="o">&amp;</span> <span class="n">z_idx</span><span class="p">)</span>

            <span class="c1"># Suspect data for this value span. Combined with the values_idx it</span>
            <span class="c1"># represents the subset ofdata that should be suspect for this member.</span>
            <span class="c1"># We split it into two indexes so we can also set all values outside of the</span>
            <span class="c1"># suspect range to GOOD by taking the inverse of the suspect_idx</span>
            <span class="n">suspect_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">inp</span> <span class="o">&lt;</span> <span class="n">m</span><span class="o">.</span><span class="n">vspan</span><span class="o">.</span><span class="n">minv</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">inp</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">vspan</span><span class="o">.</span><span class="n">maxv</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                <span class="n">flag_arr</span><span class="p">[(</span><span class="n">values_idx</span> <span class="o">&amp;</span> <span class="n">suspect_idx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">SUSPECT</span>
                <span class="n">flag_arr</span><span class="p">[(</span><span class="n">values_idx</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">suspect_idx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">GOOD</span>

        <span class="k">return</span> <span class="n">flag_arr</span></div>

<div class="viewcode-block" id="ClimatologyConfig.convert"><a class="viewcode-back" href="../../api/ioos_qc.html#ioos_qc.qartod.ClimatologyConfig.convert">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
        <span class="c1"># Create a ClimatologyConfig object if one was not passed in</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">ClimatologyConfig</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">config</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">ClimatologyConfig</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">climate_config_dict</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">**</span><span class="n">climate_config_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span></div></div>


<div class="viewcode-block" id="climatology_test"><a class="viewcode-back" href="../../api/ioos_qc.html#ioos_qc.qartod.climatology_test">[docs]</a><span class="k">def</span> <span class="nf">climatology_test</span><span class="p">(</span><span class="n">config</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ClimatologyConfig</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">]]],</span>
                     <span class="n">inp</span> <span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">N</span><span class="p">],</span>
                     <span class="n">tinp</span> <span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">N</span><span class="p">],</span>
                     <span class="n">zinp</span> <span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">N</span><span class="p">],</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Checks that values are within reasonable range bounds and flags as SUSPECT.</span>

<span class="sd">    Data for which no ClimatologyConfig member exists is marked as UNKNOWN.</span>

<span class="sd">    Args:</span>
<span class="sd">        config: A ClimatologyConfig object or a list of dicts containing tuples</span>
<span class="sd">            that can be used to create a ClimatologyConfig object. See ClimatologyConfig</span>
<span class="sd">            docs for more info.</span>
<span class="sd">        tinp: Time data as a sequence of datetime objects compatible with pandas DatetimeIndex.</span>
<span class="sd">          This includes numpy datetime64, python datetime objects and pandas Timestamp object.</span>
<span class="sd">          ie. pd.DatetimeIndex([datetime.utcnow(), np.datetime64(), pd.Timestamp.now()]</span>
<span class="sd">          If anything else is passed in the format is assumed to be seconds since the unix epoch.</span>
<span class="sd">        vinp: Input data as a numeric numpy array or a list of numbers.</span>
<span class="sd">        zinp: Z (depth) data, in meters positive down, as a numeric numpy array or a list of numbers.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A masked array of flag values equal in size to that of the input.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create a ClimatologyConfig object if one was not passed in</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">ClimatologyConfig</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">tinp</span> <span class="o">=</span> <span class="n">mapdates</span><span class="p">(</span><span class="n">tinp</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">))</span>
        <span class="n">zinp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zinp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">))</span>

    <span class="c1"># Save original shape</span>
    <span class="n">original_shape</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># We compare using a pandas Timestamp for helper functions like</span>
    <span class="c1"># &#39;week&#39; and &#39;dayofyear&#39;. It is surprisingly hard to pull these out</span>
    <span class="c1"># of a plain datetime64 object.</span>
    <span class="n">tinp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">tinp</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">zinp</span> <span class="o">=</span> <span class="n">zinp</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">flag_arr</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">tinp</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">zinp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flag_arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span></div>


<div class="viewcode-block" id="spike_test"><a class="viewcode-back" href="../../api/ioos_qc.html#ioos_qc.qartod.spike_test">[docs]</a><span class="k">def</span> <span class="nf">spike_test</span><span class="p">(</span><span class="n">inp</span> <span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">N</span><span class="p">],</span>
               <span class="n">suspect_threshold</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
               <span class="n">fail_threshold</span><span class="p">:</span> <span class="n">N</span>
               <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check for spikes by checking neighboring data against thresholds</span>

<span class="sd">    Determine if there is a spike at data point n-1 by subtracting</span>
<span class="sd">    the midpoint of n and n-2 and taking the absolute value of this</span>
<span class="sd">    quantity, and checking if it exceeds a low or high threshold.</span>
<span class="sd">    Values which do not exceed either threshold are flagged GOOD,</span>
<span class="sd">    values which exceed the low threshold are flagged SUSPECT,</span>
<span class="sd">    and values which exceed the high threshold are flagged FAIL.</span>
<span class="sd">    Missing and masked data is flagged as UNKNOWN.</span>

<span class="sd">    Args:</span>
<span class="sd">        inp: Input data as a numeric numpy array or a list of numbers.</span>
<span class="sd">        suspect_threshold: The SUSPECT threshold value, in observations units.</span>
<span class="sd">        fail_threshold: The SUSPECT threshold value, in observations units.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A masked array of flag values equal in size to that of the input.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">))</span>

    <span class="c1"># Save original shape</span>
    <span class="n">original_shape</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># Calculate the average of n-2 and n</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">inp</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

    <span class="c1"># Start with everything as passing (1)</span>
    <span class="n">flag_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate the (n-1 - ref) difference</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">inp</span> <span class="o">-</span> <span class="n">ref</span><span class="p">)</span>

    <span class="c1"># If n-1 - ref is greater than the low threshold, SUSPECT test</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">flag_arr</span><span class="p">[</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="n">suspect_threshold</span><span class="p">]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">SUSPECT</span>

    <span class="c1"># If n-1 - ref is greater than the high threshold, FAIL test</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">flag_arr</span><span class="p">[</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="n">fail_threshold</span><span class="p">]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">FAIL</span>

    <span class="c1"># If the value is masked or nan set the flag to MISSING</span>
    <span class="n">flag_arr</span><span class="p">[</span><span class="n">diff</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">MISSING</span>

    <span class="k">return</span> <span class="n">flag_arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span></div>


<div class="viewcode-block" id="rate_of_change_test"><a class="viewcode-back" href="../../api/ioos_qc.html#ioos_qc.qartod.rate_of_change_test">[docs]</a><span class="k">def</span> <span class="nf">rate_of_change_test</span><span class="p">(</span><span class="n">inp</span> <span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">N</span><span class="p">],</span>
                        <span class="n">tinp</span> <span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">N</span><span class="p">],</span>
                        <span class="n">threshold</span> <span class="p">:</span> <span class="nb">float</span>
                        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Checks the first order difference of a series of values to see if</span>
<span class="sd">    there are any values exceeding a threshold defined by the inputs.</span>
<span class="sd">    These are then marked as SUSPECT.  It is up to the test operator</span>
<span class="sd">    to determine an appropriate threshold value for the absolute difference not to</span>
<span class="sd">    exceed. Threshold is expressed as a rate in observations units per second.</span>
<span class="sd">    Missing and masked data is flagged as UNKNOWN.</span>

<span class="sd">    Args:</span>
<span class="sd">        inp: Input data as a numeric numpy array or a list of numbers.</span>
<span class="sd">        tinp: Time data as a sequence of datetime objects compatible with pandas DatetimeIndex.</span>
<span class="sd">              This includes numpy datetime64, python datetime objects and pandas Timestamp object.</span>
<span class="sd">              ie. pd.DatetimeIndex([datetime.utcnow(), np.datetime64(), pd.Timestamp.now()]</span>
<span class="sd">              If anything else is passed in the format is assumed to be seconds since the unix epoch.</span>
<span class="sd">        threshold: A float value representing a rate of change over time,</span>
<span class="sd">                   in observation units per second.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A masked array of flag values equal in size to that of the input.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">))</span>

    <span class="c1"># Save original shape</span>
    <span class="n">original_shape</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># Start with everything as passing (1)</span>
    <span class="n">flag_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>

    <span class="c1"># calculate rate of change in units/second</span>
    <span class="n">roc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>

    <span class="n">tinp</span> <span class="o">=</span> <span class="n">mapdates</span><span class="p">(</span><span class="n">tinp</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">roc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tinp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;timedelta64[s]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">flag_arr</span><span class="p">[</span><span class="n">roc</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">SUSPECT</span>

    <span class="c1"># If the value is masked set the flag to MISSING</span>
    <span class="n">flag_arr</span><span class="p">[</span><span class="n">inp</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">MISSING</span>

    <span class="k">return</span> <span class="n">flag_arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span></div>


<div class="viewcode-block" id="flat_line_test"><a class="viewcode-back" href="../../api/ioos_qc.html#ioos_qc.qartod.flat_line_test">[docs]</a><span class="k">def</span> <span class="nf">flat_line_test</span><span class="p">(</span><span class="n">inp</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">N</span><span class="p">],</span>
                   <span class="n">tinp</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">N</span><span class="p">],</span>
                   <span class="n">suspect_threshold</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="n">fail_threshold</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="n">tolerance</span><span class="p">:</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">0</span>
                   <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check for consecutively repeated values within a tolerance.</span>
<span class="sd">    Missing and masked data is flagged as UNKNOWN.</span>
<span class="sd">    More information: https://github.com/ioos/ioos_qc/pull/11</span>
<span class="sd">    Args:</span>
<span class="sd">        inp: Input data as a numeric numpy array or a list of numbers.</span>
<span class="sd">        tinp: Time data as a sequence of datetime objects compatible with pandas DatetimeIndex.</span>
<span class="sd">              This includes numpy datetime64, python datetime objects and pandas Timestamp object.</span>
<span class="sd">              ie. pd.DatetimeIndex([datetime.utcnow(), np.datetime64(), pd.Timestamp.now()]</span>
<span class="sd">              If anything else is passed in the format is assumed to be seconds since the unix epoch.</span>
<span class="sd">        suspect_threshold: The number of seconds within `tolerance` to</span>
<span class="sd">            allow before being flagged as SUSPECT.</span>
<span class="sd">        fail_threshold: The number of seconds within `tolerance` to</span>
<span class="sd">            allow before being flagged as FAIL.</span>
<span class="sd">        tolerance: The tolerance that should be exceeded between consecutive values.</span>
<span class="sd">            To determine if the current point `n` should be flagged, we use a rolling window, with endpoint at</span>
<span class="sd">            point `n`, and calculate the range of values in the window. If that range is less than `tolerance`,</span>
<span class="sd">            then the point is flagged.</span>
<span class="sd">    Returns:</span>
<span class="sd">        A masked array of flag values equal in size to that of the input.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># input as numpy arr</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">))</span>

    <span class="c1"># Save original shape</span>
    <span class="n">original_shape</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># Start with everything as passing</span>
    <span class="n">flag_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">inp</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">GOOD</span><span class="p">)</span>

    <span class="c1"># if we have fewer than 3 points, we can&#39;t run the test, so everything passes</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flag_arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span>

    <span class="c1"># determine median time interval</span>
    <span class="n">tinp</span> <span class="o">=</span> <span class="n">mapdates</span><span class="p">(</span><span class="n">tinp</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># The thresholds are in seconds so we round make sure the interval is also in seconds</span>
    <span class="n">time_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tinp</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;timedelta64[s]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rolling_window</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        https://rigtorp.se/2011/01/01/rolling-statistics-numpy.html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">window</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">strides</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">strides</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">arr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

    <span class="k">def</span> <span class="nf">run_test</span><span class="p">(</span><span class="n">test_threshold</span><span class="p">,</span> <span class="n">flag_value</span><span class="p">):</span>
        <span class="c1"># convert time thresholds to number of observations</span>
        <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">test_threshold</span><span class="p">)</span> <span class="o">/</span> <span class="n">time_interval</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># calculate actual data ranges for each window</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">rolling_window</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
        <span class="n">data_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">data_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">data_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_max</span> <span class="o">-</span> <span class="n">data_min</span><span class="p">)</span>

        <span class="c1"># find data ranges that are within threshold and flag them</span>
        <span class="n">test_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">data_range</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># data points before end of first window should pass</span>
        <span class="n">n_fill</span> <span class="o">=</span> <span class="n">count</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
        <span class="n">test_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">test_results</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_fill</span><span class="p">,),</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">flag_arr</span><span class="p">[</span><span class="n">test_results</span><span class="p">]</span> <span class="o">=</span> <span class="n">flag_value</span>

    <span class="n">run_test</span><span class="p">(</span><span class="n">suspect_threshold</span><span class="p">,</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">SUSPECT</span><span class="p">)</span>
    <span class="n">run_test</span><span class="p">(</span><span class="n">fail_threshold</span><span class="p">,</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">FAIL</span><span class="p">)</span>

    <span class="c1"># If the value is masked set the flag to MISSING</span>
    <span class="n">flag_arr</span><span class="p">[</span><span class="n">inp</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">MISSING</span>

    <span class="k">return</span> <span class="n">flag_arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span></div>


<div class="viewcode-block" id="attenuated_signal_test"><a class="viewcode-back" href="../../api/ioos_qc.html#ioos_qc.qartod.attenuated_signal_test">[docs]</a><span class="k">def</span> <span class="nf">attenuated_signal_test</span><span class="p">(</span><span class="n">inp</span> <span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">N</span><span class="p">],</span>
                           <span class="n">threshold</span> <span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">],</span>
                           <span class="n">check_type</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;std&#39;</span>
                           <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check for near-flat-line conditions using a range or standard deviation.</span>

<span class="sd">    Missing and masked data is flagged as UNKNOWN.</span>

<span class="sd">    Args:</span>
<span class="sd">        inp: Input data as a numeric numpy array or a list of numbers.</span>
<span class="sd">        threshold: 2-tuple representing the minimum thresholds to use for SUSPECT</span>
<span class="sd">            and FAIL checks. The smaller of the two values is used in the SUSPECT</span>
<span class="sd">            tests and the greater of the two values is used in the FAIL tests.</span>
<span class="sd">        check_type: Either &#39;std&#39; (default) or &#39;range&#39;, depending on the type of check</span>
<span class="sd">            you wish to perform.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A masked array of flag values equal in size to that of the input.</span>
<span class="sd">        This array will always contain only a single unique value since all</span>
<span class="sd">        input data is flagged together.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">isfixedlength</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">span</span><span class="p">(</span><span class="o">*</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">threshold</span><span class="p">)))</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">))</span>

    <span class="c1"># Save original shape</span>
    <span class="n">original_shape</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">check_type</span> <span class="o">==</span> <span class="s1">&#39;std&#39;</span><span class="p">:</span>
        <span class="n">check_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">check_type</span> <span class="o">==</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span>
        <span class="n">check_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Check type &quot;</span><span class="si">{}</span><span class="s1">&quot; is not defined&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_type</span><span class="p">))</span>

    <span class="c1"># Start with everything as passing (1)</span>
    <span class="n">flag_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">check_val</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="o">.</span><span class="n">maxv</span><span class="p">:</span>
        <span class="n">flag_arr</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">QartodFlags</span><span class="o">.</span><span class="n">FAIL</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">check_val</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="o">.</span><span class="n">minv</span><span class="p">:</span>
        <span class="n">flag_arr</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">QartodFlags</span><span class="o">.</span><span class="n">SUSPECT</span><span class="p">)</span>

    <span class="c1"># If the value is masked set the flag to MISSING</span>
    <span class="n">flag_arr</span><span class="p">[</span><span class="n">inp</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">QartodFlags</span><span class="o">.</span><span class="n">MISSING</span>

    <span class="k">return</span> <span class="n">flag_arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_shape</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">ioos_qc</a></h1>



<p class="blurb">IOOS QARTOD and other Quality Control tests implemented in Python</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=ioos&repo=ioos_qc&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources.html">IOOS QARTOD Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Notebook Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">IOOS QC Releases and Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other.html">Other QARTOD Implementations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">ioos_qc</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, IOOS.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>